<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Slop - SyteLine Order Processor</title>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- PapaParse -->
    <script src="./papaparse/papaparse.min.js"></script>

    <style>
        body {
            font-family: Roboto, "Open Sans", sans-serif;
            font-weight: 300;
            text-rendering: optimizeLegibility;
        }

        #drop_zone {
            border: 3px dashed #aaaaaa;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            min-height: 200px;
            color: #aaaaaa;
            font-size: 20pt;
        }

        .note {
            font-size: 8pt;
            color: #999999;
        }

        /*noinspection CssUnusedSymbol*/
        .btn-supp {
            margin: 5px;
        }

        html {
            position: relative;
            min-height: 100%;
        }
        body {
            margin-bottom: 80px; /* Margin bottom by footer height */
        }

        footer {
            position: absolute;
            bottom: 0;
            width: calc(100% - 84px);
            height: 80px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SyteLine Order Processor</h1>
    <i>Turn online orders into SyteLine POs fast and easy!*</i>
    <p>This tool will probably have bugs. Please verify its outputs. </p>
    <p class="note">All order data is processed in the browser. Nothing is sent to the server.</p>
    <hr>

    <div class="row" id="div-supp">
        <div class="col text-center" id="supplier-select">
            <p style="font-size: larger">Select a supplier</p>
        </div>
    </div>
    <div class="row" id="div-process" hidden>
        <div class="col-sm-6" style="border-right: 1px solid #ccc;">
            <h2 id="import-title">Import DigiKey order</h2>

            <input style="display: none" type="file" id="file-input">
            <div id="drop_zone" onclick="document.getElementById('file-input').click()">
                <span style="font-size: 40pt" class="glyphicon glyphicon-file"></span><br>
                <p class="dropzone-prompt"></p>
                <p class="dropzone-filename" hidden></p>
            </div>
            <br>
            <div class="alert alert-danger" id="drop_zone-error" hidden></div>
            <div class="alert alert-success" id="drop_zone-success" hidden></div>
        </div>

        <div class="col-sm-6" id="export-col">
            <h2>Export to SyteLine</h2>

            <div class="form-group">
                <label for="category">Category:</label>
                <input type="text" class="form-control" oninput="InputChanged(this)" onfocusout="Validate(this)" id="category" maxlength="30" placeholder="Project Materials" value="Project Materials">
            </div>
            <div class="form-group">
                <label for="project">Project code:</label>
                <input type="text" class="form-control" oninput="InputChanged(this)" onfocusout="Validate(this)" id="project" maxlength="20" placeholder="ex. C30402">
            </div>

            <button type="button" class="btn btn-primary" id="btn-copy" onclick="Generate()" disabled>
                Copy data to clipboard
            </button>
            <br><br>
            <div id="copy-complete" hidden>
                <div class="alert alert-info">
                    <strong>Copied!</strong>
                    To add the data to a purchase order, go to <i>Edit</i> > <i>Paste Rows Append</i>
                </div>
                <i class="note">
                    Warning: this might not work if the PO columns are not in their default order in SyteLine
                </i>
            </div>
        </div>
    </div>

    <footer>
        <hr>
        <p style="text-align: left">
            <i>*speed and/or ease not guaranteed</i>
            <span style="float: right; color: #d0d0d0">Joel Bowring</span>
        </p>
    </footer>
</div>

<script>
    let supplier = null;
    const suppliers = {
        "digikey": {
            name: "DigiKey",
            type: "csv",
            fileType: ".csv",
        },
        "farnell": {
            name: "Farnell",
            type: "csv",
            fileType: ".csv",
        },
    }

    for (const [id, _supplier] of Object.entries(suppliers)) {
        let button = document.createElement('button');
        button.id = id;
        button.setAttribute('onclick', 'setSupplier(this.id)');
        button.className = "btn btn-primary btn-lg btn-supp";
        button.innerText = _supplier.name;
        document.getElementById('supplier-select').appendChild(button);
    }

    class Product {
        constructor(description, quantity, price) {
            this.description = description;
            this.quantity = quantity;
            this.price = price;
        }
    }

    let products = [];
    let productsValid = false;

    const fileInput = document.getElementById("file-input");
    const dropZone = document.getElementById("drop_zone");
    const dropZonePrompt = document.getElementsByClassName("dropzone-prompt")[0]
    const copyCompleteDiv = document.getElementById("copy-complete");

    function setSupplier(id) {
        supplier = id;
        let _supplier = suppliers[id];
        document.getElementById("div-supp").hidden = true;
        document.getElementById("import-title").innerText = "Import " + _supplier.name + " order";
        if(_supplier.type === "csv") {
            dropZonePrompt.innerHTML = "Drop " + _supplier.name + " basket " + _supplier.fileType + " here";
            dropZonePrompt.innerHTML += '<p style="font-size: 15px">(or click to choose a file)</p>';
        }
        document.getElementById("div-process").hidden = false;
        document.getElementById("file-input").setAttribute("accept", _supplier.fileType)
    }

    function stripHeader(header) {
        return header.replace(/[^A-z]/g, '').toLowerCase()
    }

    function CsvParse(file, callback) {
        const translations = {
            Description: [
                "Manufacturer / Description",
                "Description",
            ],
            Quantity: [
                "Quantity",
                "Qty",
            ],
            Price: [
                "Unit Cost",
                "Unit Price",
            ],
        }

        Papa.parse(file, {
            complete: function (results) {
                let index = {}
                for (const [destination, sources] of Object.entries(translations)) {
                    for (const source of sources.map(stripHeader)) {
                        if (results.meta.fields.includes(source)) {
                            index[stripHeader(destination)] = source;
                            break;
                        }
                    }
                }

                let errors = []
                for (const error of results.errors) {
                    if(! ['TooFewFields', 'TooManyFields'].includes(error.code) )
                    errors.push("<b>Row " + error.row + ":</b> " + error.message);
                }
                if (errors.length === 0) {
                    for (const [destination, sources] of Object.entries(translations)) {
                        if (!index.hasOwnProperty(stripHeader(destination))) {
                            errors.push('<b>' + destination + '</b> column not found, tried looking for ' + sources.map((s) => '"'+s+'"').join(", "));
                        }
                    }
                }

                if(errors.length !== 0) {
                    callback([], errors);
                } else {
                    let products = [];
                    for (const line of results.data) {
                        if(Object.entries(line).every(([, value]) => value === "")) {
                            break;
                        }
                        products.push(new Product(
                            line[index.description],
                            line[index.quantity],
                            line[index.price],
                        ))
                    }
                    callback(products, errors);
                }
            },
            delimiter: ',',
            header: true,
            transformHeader: stripHeader,
            dynamicTyping: function (header) {
                for(const source of translations.Quantity.concat(translations.Price)) {
                    if (header === stripHeader(source)) {
                        return true;
                    }
                }
                return false;
            }
        });
    }

    function InputChanged(element) {
        copyCompleteDiv.hidden = true;
        Validate(element);
    }

    function Validate(element) {
        const parentFormGroup = element.closest(".form-group");
        const errorClass = "has-error";
        if(FieldValid(element.id)) {
            parentFormGroup.classList.remove(errorClass);
        } else {
            parentFormGroup.classList.add(errorClass);
        }

        ValidatePage();
    }

    function FieldValid(id) {
        switch(id) {
            case "category":
                return document.getElementById(id).value.length > 0;
            case "project":
                return document.getElementById(id).value.length > 0;
            default:
                return false;
        }
    }

    function ValidatePage() {
        let valid = productsValid && FieldValid("category") && FieldValid("project")
        document.getElementById("btn-copy").disabled = !valid;
        if(!valid) {
            copyCompleteDiv.hidden = true;
        }
        return valid;
    }

    function Generate() {
        let copyComplete = document.getElementById("copy-complete");
        copyComplete.hidden = true;
        if (ValidatePage()) {
            let out = "";
            const category = document.getElementById("category").value;
            const project = document.getElementById("project").value;
            for(const product of products) {
                let row = [];
                row.push(category)
                row.push(product.description);
                row.push(project);
                row.push("");
                row.push("");
                row.push(product.quantity.toString())
                row.push(product.price.toString())

                // SyteLine only allows 60 characters as a field length
                row = row.map(value => value.substring(0, 60))

                out += row.join('\t') + "\r\n";
            }
            WriteClipboard(out, (success) => {
                if(success) {
                    setTimeout(() => {
                        copyComplete.hidden = false;
                    }, 100);
                }
            })
        }
    }

    function WriteClipboard(contents, callback) {
        let textArea = document.createElement("textarea");

        // Place in the top-left corner of screen regardless of scroll position.
        textArea.style.position = 'fixed';
        textArea.style.top = "0";
        textArea.style.left = "0";

        // Ensure it has a small width and height. Setting to 1px / 1em
        // doesn't work as this gives a negative w/h on some browsers.
        textArea.style.width = '2em';
        textArea.style.height = '2em';

        // We don't need padding, reducing the size if it does flash render.
        textArea.style.padding = "0";

        // Clean up any borders.
        textArea.style.border = 'none';
        textArea.style.outline = 'none';
        textArea.style.boxShadow = 'none';

        // Avoid flash of the white box if rendered for any reason.
        textArea.style.background = 'transparent';

        textArea.value = contents;

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        let success = false;
        try {
            success = document.execCommand('copy');
        } catch (err) {
            console.log(err);
        }

        if(!success) {
            console.log('Copying text command was unsuccessful');
        }

        document.body.removeChild(textArea);

        callback(success, contents);
    }

    function handleFile(file, error) {
        let errorBox = document.getElementById("drop_zone-error");
        let successBox = document.getElementById("drop_zone-success");

        let dropzoneFilename = dropZone.getElementsByClassName("dropzone-filename")[0];
        let dropzonePrompt = dropZone.getElementsByClassName("dropzone-prompt")[0];

        let errorBoxWasHidden = errorBox.hidden;
        errorBox.hidden = true;
        let successBoxWasHidden = successBox.hidden;
        successBox.hidden = true;

        copyCompleteDiv.hidden = true;
        document.getElementById("drop_zone-success").hidden = true;

        // noinspection JSUnresolvedVariable
        if(error) {
            errorBox.innerText = error;
            errorBox.hidden = false;
            dropzoneFilename.hidden = true;
            dropzonePrompt.hidden = false;
            return;
        }

        dropzoneFilename.innerText = file.name;
        dropzoneFilename.hidden = false;
        dropzonePrompt.hidden = true;

        function processDropzoneProducts(_products, errors) {
            if(errors.length > 0) {
                products = []
                productsValid = false;
                const messageLimit = 5;
                if (errors.length > messageLimit) {
                    let remaining = errors.length - messageLimit;
                    errors = errors.slice(0, messageLimit);
                    errors.push("<b>" + remaining + " more...</b>");
                }
                errorBox.innerHTML = errors.join("<br>");
                setTimeout(() => errorBox.hidden = false, errorBoxWasHidden ? 0: 100);
            } else {
                products = _products;
                if (products.length === 0) {
                    successBox.hidden = true;
                    productsValid = false;
                } else {
                    let productCount = 0, totalCost = 0;
                    for (const product of products) {
                        productCount += product.quantity;
                        totalCost += product.quantity * product.price;
                    }
                    successBox.innerText = productCount + " products found, total cost: " + totalCost.toFixed(2);
                    productsValid = true;
                    setTimeout(() => successBox.hidden = false, successBoxWasHidden ? 0: 100);
                }
            }

            ValidatePage();
        }

        if(suppliers[supplier].type === "csv") {
            CsvParse(file, processDropzoneProducts);
        }
    }

    function handleFileInput() {
        if (this.files.length !== 1) {
            handleFile(null, "Please upload a single file and try again.");
        } else {
            handleFile(this.files[0], "");
        }
    }

    function handleFileDrop(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        // noinspection JSUnresolvedVariable
        if(!(evt.dataTransfer.items[0].webkitGetAsEntry().isFile && evt.dataTransfer.files.length === 1)) {
            handleFile(null, "Please upload a single file and try again.");
        } else {
            handleFile(evt.dataTransfer.files[0], "");
        }
    }

    function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }

    fileInput.addEventListener('change', handleFileInput, false);

    // Setup the dnd listeners.
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileDrop, false);
</script>

</body>
</html>