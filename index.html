<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Slop - SyteLine Order Processor</title>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- PapaParse -->
    <script src="./papaparse/papaparse.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <script src="https://unpkg.com/esprima@~4.0/dist/esprima.js"></script>
    <script src="https://estools.github.io/escodegen/escodegen.browser.js"></script>

    <style>
        body {
            font-family: Roboto, "Open Sans", sans-serif;
            font-weight: 300;
            text-rendering: optimizeLegibility;
        }

        #drop_zone {
            border: 3px dashed #aaaaaa;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            min-height: 200px;
            color: #aaaaaa;
            font-size: 20pt;
        }

        .note {
            font-size: 8pt;
            color: #999999;
        }

        /*noinspection CssUnusedSymbol*/
        .btn-supp {
            margin: 5px;
        }

        html {
            position: relative;
            min-height: 100%;
        }
        body {
            margin-bottom: 80px; /* Margin bottom by footer height */
        }

        footer {
            position: absolute;
            bottom: 0;
            /*width: 100%;*/
            /*width: calc(100% - 84px);*/
            /*height: 80px;*/
            height: 40px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SyteLine Order Processor</h1>
    <i>Turn online orders into SyteLine POs fast and easy!</i>
    <p>This tool will probably have bugs. Please verify its outputs. </p>
    <p class="note">All order data is processed in the browser. Nothing is sent to the server.
    </p>
    <hr>

    <div class="row" id="div-supp">
        <div class="col text-center" id="supplier-select">
            <p style="font-size: larger">Select a supplier</p>
        </div>
    </div>
    <div class="row" id="div-process" hidden>
        <div class="col-sm-6" style="border-right: 1px solid #ccc;">
            <h2 id="import-title">Import DigiKey order</h2>

            <label for="file-input" id="file-input-label" hidden></label>
            <input style="display: none" type="file" id="file-input">
            <div id="drop_zone" onclick="fileInput.click()">
                <span style="font-size: 40pt" class="glyphicon glyphicon-file"></span><br>
                <p class="dropzone-prompt"></p>
                <p class="dropzone-filename" hidden></p>
            </div>
            <br>
            <div class="alert alert-danger" id="drop_zone-error" hidden></div>
            <div class="alert alert-success" id="drop_zone-success" hidden></div>
            <div class="alert alert-warning" id="drop_zone-warning" hidden><b>Warning: </b> some data may be missing</div>
        </div>

        <div class="col-sm-6" id="export-col">
            <h2>Export to SyteLine</h2>

            <div class="form-group">
                <label for="category">Category:</label>
                <input type="text" class="form-control" oninput="InputChanged(this)" onfocusout="Validate(this)" id="category" maxlength="30" placeholder="Project Materials" value="Project Materials">
            </div>
            <div class="form-group">
                <label for="project">Project code:</label>
                <input type="text" class="form-control" oninput="InputChanged(this)" onfocusout="Validate(this)" id="project" maxlength="20" placeholder="ex. C30402">
            </div>

            <button type="button" class="btn btn-primary" id="btn-copy" onclick="Generate()" disabled>
                Copy data to clipboard
            </button>
            <br><br>
            <div id="copy-complete" hidden>
                <div class="alert alert-info">
                    <strong>Copied!</strong>
                    To add the data to a purchase order, click anywhere in the table and go to <i>Edit</i> > <i>Paste Rows Append</i>
                </div>
                <i class="note">
                    Warning: this might not work if the PO columns are not in their default order in SyteLine
                </i>
            </div>
        </div>
    </div>
</div>

<script>
    let supplier = null;
    const suppliers = {
        "digikey": {
            name: "DigiKey",
            type: "csv",
            fileType: ".csv",
        },
        "farnell": {
            name: "Farnell",
            type: "csv",
            fileType: ".csv",
        },
        "avnet": {
            name: "Avnet",
            type: "csv",
            fileType: ".csv",
            config: {
                delimiter: '\t',
            }
        },
        "mouser": {
            name: "Mouser",
            type: "xls",
            fileType: ".xls",
        },
        "rs": {
            name: "RS Components",
            type: "rs",
            fileType: ".html",
        },
    }

    for (const [id, _supplier] of Object.entries(suppliers)) {
        let button = document.createElement('button');
        button.id = id;
        button.setAttribute('onclick', 'setSupplier(this.id)');
        button.className = "btn btn-primary btn-lg btn-supp";
        button.innerText = _supplier.name;
        document.getElementById('supplier-select').appendChild(button);
    }

    class Product {
        constructor(description, quantity, price) {
            this.description = description;
            this.quantity = quantity;
            this.price = price;
        }
    }

    let products = [];
    let productsValid = false;

    const fileInput = document.getElementById("file-input");
    const dropZone = document.getElementById("drop_zone");
    const dropZonePrompt = document.getElementsByClassName("dropzone-prompt")[0]
    const copyCompleteDiv = document.getElementById("copy-complete");

    function setSupplier(id) {
        supplier = id;
        let _supplier = suppliers[id];
        document.getElementById("div-supp").hidden = true;
        document.getElementById("import-title").innerText = "Import " + _supplier.name + " order";
        document.getElementById('file-input-label').innerText = "Upload " + _supplier.name + " basket " + _supplier.fileType + " file";
        dropZonePrompt.innerHTML = "Drop " + _supplier.name + " basket " + _supplier.fileType + " here";
        dropZonePrompt.innerHTML += '<p style="font-size: 15px">(or click to choose a file)</p>';
        document.getElementById("div-process").hidden = false;
        fileInput.setAttribute("accept", _supplier.fileType)
    }

    function RsParse(file, callback, config) {
        let reader = new FileReader();
        reader.onerror = () => {
            callback([], ["Failed to read file:\n" + reader.error])
        };
        reader.onload = file => {
            let rs = document.createElement('html');
            rs.innerHTML = file.target.result
            let rsJs = "";
            for (const script of rs.getElementsByTagName('script')) {
                rsJs += script.innerText + "\n"
            }
            rs.remove();

            let pageData;
            let parsed = esprima.parseScript(rsJs, { tolerant: true })
            if (parsed && parsed.body) {
                for (const bodyKey of parsed.body) {
                    if (bodyKey.type === "VariableDeclaration" && 'declarations' in bodyKey) {
                        for (const declaration of bodyKey.declarations) {
                            if (
                                declaration.type === "VariableDeclarator" &&
                                'id' in declaration &&
                                declaration.id.type === "Identifier" &&
                                declaration.id.name === "pageData" &&
                                'init' in declaration
                            ) {
                                pageData = JSON.parse(escodegen.generate(declaration.init, { format: {json: true} }));
                            }
                        }
                    }
                }
            } else {
                callback([], ["Failed to parse HTML"]);
                return;
            }

            let products = [];
            let errors = [];
            let showWarning = false;
            if('products' in pageData && 'basketBreakPrices' in pageData) {
                if(pageData.products.length !== pageData.basketBreakPrices.length) {
                    showWarning = true;
                }
                let numProducts = Math.min(pageData.products.length, pageData.basketBreakPrices.length)

                for (let i = 0; i < numProducts; i++) {
                    let basketBreakPrice = pageData.basketBreakPrices[i];
                    if (typeof basketBreakPrice === 'string') {
                        try {
                            basketBreakPrice = JSON.parse(basketBreakPrice)
                        } catch {}
                    }

                    const product = pageData.products[i];

                    let breakPrices = {};
                    if(typeof basketBreakPrice === 'object' && 'breakPrices' in basketBreakPrice) {
                        for (const breakPrice of basketBreakPrice.breakPrices) {
                            let quantity = parseFloat(breakPrice.quantity);
                            let price = parseFloat(breakPrice.price);
                            if (!isNaN(quantity) && !isNaN(price)) {
                                breakPrices[quantity] = price;
                            } else {
                                showWarning = true;
                                breakPrices = {};
                                break;
                            }
                        }
                    }

                    let quantity = NaN;
                    try {
                        quantity = parseFloat(product.orderQuantity.quantity)
                    } catch {}

                    if(
                        Object.keys(breakPrices).length !== 0 &&
                        'description' in product &&
                        'orderQuantity' in product &&
                        'quantity' in product.orderQuantity &&
                        !isNaN(quantity)
                    ) {
                        for (const breakQuantity of Object.keys(breakPrices).sort().reverse()) {
                            if (quantity >= breakQuantity) {
                                products.push(new Product(
                                    String(product.description),
                                    quantity,
                                    breakPrices[breakQuantity],
                                ))
                                break;
                            }
                        }
                    } else {
                        showWarning = true;
                    }
                }
            } else {
                errors.push('Data not found in webpage')
            }
            console.table(products)
            callback(products, errors, showWarning)
        };
        reader.readAsText(file);
    }
    
    function findData(data, callback) {
        const translations = {
            Description: [
                /(?:manufacturer)?description/,
                /products/,
            ],
            Quantity: [
                /quantity/,
                /(?:order)?qty/,
            ],
            Price: [
                /unit(?:cost|price)/,
                /price(?:[A-Z]{3}|unit)/,
            ],
        }

        // Add "ignore case" flag
        for (const translation in translations) {
            translations[translation] = translations[translation].map(regex => RegExp(regex.source, "i"));
        }

        let headerMap;
        let headerRow = null;
        for (let row = 0; row < data.length; row++) {
            headerMap = {};
            if (Object.keys(translations).every(header => {
                for (const [col, cell] of Object.entries(data[row])) {
                    if (!Object.values(headerMap).includes(col) && translations[header].some(regex => {
                        return cell.replace(/\W/g, '').match(regex) !== null;
                    })) {
                        headerMap[header] = col;
                        return true;
                    }
                }
            })) {
                headerRow = row;
                break;
            }
        }

        if(headerRow === null) {
            callback([], [Object.keys(translations).join(", ") + " headers not found"]);
            return;
        }

        let products = [], errors = [];
        let showWarning = false, end = false;
        for (const line of data.slice(headerRow+1)) {
            if(line.every(value => value === "")) {
                break;
            }

            // Remove extraneous characters
            let priceString = line[headerMap.Price].replace(/[^0-9.,]/g, '')

            let separators = priceString.match(/[^0-9]/g)
            if (separators !== null && separators.length > 0) {
                let decimalSeparator = separators[separators.length - 1]
                // Remove all other separators
                priceString = priceString.replace(RegExp('[^0-9' + decimalSeparator + ']', 'g'), '')
                // Format with decimal point
                if (decimalSeparator !== '.') {
                    priceString = priceString.replace(/[^0-9]/g, '.')
                }
            }
            let price = parseFloat(priceString);

            let quantity = parseFloat(line[headerMap.Quantity].replaceAll(',', ''));

            if(line[headerMap.Description] === "" || isNaN(quantity) || isNaN(price)) {
                end = true;
            } else {
                if(end) {
                    showWarning = true;
                }
                products.push(new Product(
                    line[headerMap.Description],
                    quantity,
                    price,
                ))
            }
        }
        callback(products, errors, showWarning);
    }

    function XlsParse(file, callback, config) {
        if (!config) {
            config = {};
        }

        let reader = new FileReader();
        reader.onload = file => {
            let data = new Uint8Array(file.target.result);
            let workbook = XLSX.read(data, {type: 'array'});
            if(workbook.Sheets.length < 1 || workbook.SheetNames.length < 1) {
                callback([], ["No sheets found in workbook"])
                return;
            }
            findData(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw:false, header:1}), callback);
        };
        reader.onerror = () => {
            callback([], ["Failed to read file:\n" + reader.error])
        };
        reader.readAsArrayBuffer(file);
    }

    function CsvParse(file, callback, config) {
        if (!config) {
            config = {};
        }

        Papa.parse(file, {
            complete: function (results) {
                let errors = [];
                for (const error of results.errors) {
                    if(! ['TooFewFields', 'TooManyFields'].includes(error.code) )
                    errors.push("<b>Row " + error.row + ":</b> " + error.message);
                }

                if(errors.length !== 0) {
                    callback([], errors);
                } else {
                    findData(results.data, callback);
                }
            },
            delimiter: input => {
                let delimiter = ',';
                if ('delimiter' in config) {
                    delimiter = config.delimiter;
                }
                let sepMatch = input.match(/^sep=([^\r\n])/i);
                if (sepMatch !== null && sepMatch.length > 1) {
                    delimiter = sepMatch[1];
                }

                return delimiter;
            },
        });
    }

    function InputChanged(element) {
        copyCompleteDiv.hidden = true;
        Validate(element);
    }

    function Validate(element) {
        const parentFormGroup = element.closest(".form-group");
        const errorClass = "has-error";
        if(FieldValid(element.id)) {
            parentFormGroup.classList.remove(errorClass);
        } else {
            parentFormGroup.classList.add(errorClass);
        }

        ValidatePage();
    }

    function FieldValid(id) {
        switch(id) {
            case "category":
            case "project":
                return document.getElementById(id).value.length > 0;
            default:
                return false;
        }
    }

    function ValidatePage() {
        let valid = productsValid && FieldValid("category") && FieldValid("project")
        document.getElementById("btn-copy").disabled = !valid;
        if(!valid) {
            copyCompleteDiv.hidden = true;
        }
        return valid;
    }

    function Generate() {
        copyCompleteDiv.hidden = true;
        if (ValidatePage()) {
            let out = "";
            const category = document.getElementById("category").value;
            const project = document.getElementById("project").value;
            for(const product of products) {
                let row = [];
                row.push(category)
                row.push(product.description);
                row.push(project);
                row.push("");
                row.push("");
                row.push(product.quantity.toString())
                row.push(product.price.toString())

                // SyteLine only allows 60 characters as a field length
                row = row.map(value => value.substring(0, 60))

                out += row.join('\t') + "\r\n";
            }
            WriteClipboard(out, (success) => {
                if(success) {
                    setTimeout(() => {
                        copyCompleteDiv.hidden = false;
                    }, 100);
                }
            })
        }
    }

    function WriteClipboard(contents, callback) {
        let textArea = document.createElement("textarea");

        // Place in the top-left corner of screen regardless of scroll position.
        textArea.style.position = 'fixed';
        textArea.style.top = "0";
        textArea.style.left = "0";

        // Ensure it has a small width and height. Setting to 1px / 1em
        // doesn't work as this gives a negative w/h on some browsers.
        textArea.style.width = '2em';
        textArea.style.height = '2em';

        // We don't need padding, reducing the size if it does flash render.
        textArea.style.padding = "0";

        // Clean up any borders.
        textArea.style.border = 'none';
        textArea.style.outline = 'none';
        textArea.style.boxShadow = 'none';

        // Avoid flash of the white box if rendered for any reason.
        textArea.style.background = 'transparent';

        textArea.value = contents;

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        let success = false;
        try {
            success = document.execCommand('copy');
        } catch (err) {
            console.log(err);
        }

        if(!success) {
            console.log('Copying text command was unsuccessful');
        }

        document.body.removeChild(textArea);

        callback(success, contents);
    }

    function handleFile(file, error) {
        let errorBox = document.getElementById("drop_zone-error");
        let successBox = document.getElementById("drop_zone-success");
        let warningBox = document.getElementById("drop_zone-warning");

        let dropzoneFilename = dropZone.getElementsByClassName("dropzone-filename")[0];
        let dropzonePrompt = dropZone.getElementsByClassName("dropzone-prompt")[0];

        let errorBoxWasHidden = errorBox.hidden;
        errorBox.hidden = true;
        let successBoxWasHidden = successBox.hidden;
        successBox.hidden = true;
        let warningBoxWasHidden = warningBox.hidden;
        warningBox.hidden = true;

        copyCompleteDiv.hidden = true;
        successBox.hidden = true;

        // noinspection JSUnresolvedVariable
        if(error) {
            errorBox.innerText = error;
            errorBox.hidden = false;
            dropzoneFilename.hidden = true;
            dropzonePrompt.hidden = false;
            return;
        }

        dropzoneFilename.innerText = file.name;
        dropzoneFilename.hidden = false;
        dropzonePrompt.hidden = true;

        function processDropzoneProducts(_products, errors, showWarning) {
            if(errors.length > 0) {
                products = []
                productsValid = false;
                const messageLimit = 5;
                if (errors.length > messageLimit) {
                    let remaining = errors.length - messageLimit;
                    errors = errors.slice(0, messageLimit);
                    errors.push("<b>" + remaining + " more...</b>");
                }
                errorBox.innerHTML = errors.join("<br>");
                setTimeout(() => errorBox.hidden = false, errorBoxWasHidden ? 0: 100);
            } else {
                products = _products;
                if (products.length === 0) {
                    successBox.hidden = true;
                    productsValid = false;
                } else {
                    let productCount = 0, totalCost = 0;
                    for (const product of products) {
                        productCount += product.quantity;
                        totalCost += product.quantity * product.price;
                    }
                    successBox.innerHTML = '<b>' + products.length + ' item' + (products.length>1?'s':'') + ' found </b><br>Total quantity: ' + productCount + "<br>Total cost: " + totalCost.toFixed(2);
                    if(showWarning) {
                        setTimeout(() => warningBox.hidden = false, warningBoxWasHidden ? 0: 100);
                    }
                    productsValid = true;
                    setTimeout(() => successBox.hidden = false, successBoxWasHidden ? 0: 100);
                }
            }

            ValidatePage();
        }

        let config = {}
        if ('config' in suppliers[supplier]) {
            config = suppliers[supplier].config;
        }

        if(suppliers[supplier].type === "csv") {
            CsvParse(file, processDropzoneProducts, config);
        } else if(suppliers[supplier].type === "xls") {
            XlsParse(file, processDropzoneProducts, config);
        } else if(suppliers[supplier].type === "rs") {
            RsParse(file, processDropzoneProducts, config);
        }
    }

    function handleFileInput() {
        if (this.files.length !== 1) {
            handleFile(null, "Please upload a single file and try again.");
        } else {
            handleFile(this.files[0], "");
        }
    }

    function handleFileDrop(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        // noinspection JSUnresolvedVariable
        if(!(evt.dataTransfer.items[0].webkitGetAsEntry().isFile && evt.dataTransfer.files.length === 1)) {
            handleFile(null, "Please upload a single file and try again.");
        } else {
            handleFile(evt.dataTransfer.files[0], "");
        }
    }

    function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }

    fileInput.addEventListener('change', handleFileInput, false);

    // Setup the dnd listeners.
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileDrop, false);
</script>

</body>
</html>